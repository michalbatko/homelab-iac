- name: Synchronize certificates between automation hosts
  hosts: automation_hosts
  gather_facts: yes
  become: yes
  vars:
    letsencrypt_dir: /etc/letsencrypt/live
    ansible_ssh_timeout: 30
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30'
    
  tasks:
    - name: Find certificate directories
      find:
        paths: "{{ letsencrypt_dir }}"
        file_type: directory
      register: local_cert_dirs
      
    - name: Show found certificate directories 
      debug:
        msg: "{{ inventory_hostname }}: {{ local_cert_dirs.files | length }} certificates - {{ local_cert_dirs.files | map(attribute='path') | map('basename') | sort | join(', ') }}"
      
    - name: Extract certificate domains and expiry dates
      shell: |
        if [ -f "{{ item.path }}/cert.pem" ]; then
          domain=$(openssl x509 -in "{{ item.path }}/cert.pem" -subject -noout | sed 's/subject=CN = //')
          expiry_raw=$(openssl x509 -in "{{ item.path }}/cert.pem" -enddate -noout | cut -d= -f2)
          expiry=$(date -d "$expiry_raw" "+%Y%m%d-%H%M" 2>/dev/null || echo "$expiry_raw")
          echo "{{ item.path | basename }}:${domain}:${expiry}"
        else
          echo "{{ item.path | basename }}:MISSING:MISSING"
        fi
      loop: "{{ local_cert_dirs.files }}"
      register: cert_details
      changed_when: false
      no_log: true
      
    - name: Show certificate status summary
      debug:
        msg: "{{ inventory_hostname }}: {% for result in cert_details.results %}{%- set parts = result.stdout.split(':') -%}{%- set cert_name = parts[0] -%}{%- set domain = parts[1] -%}{%- set expiry = parts[2] -%}{%- if domain == 'MISSING' -%}[MISSING]{{ cert_name }}{%- else -%}[PRESENT]{{ cert_name }}({{ expiry }}){%- endif -%}{% if not loop.last %}; {% endif %}{% endfor %}"
      
    - name: Build certificate inventory across all hosts
      debug:
        msg: "TODO: Collect all certificate info from all automation hosts into unified inventory"
      run_once: true
      
    - name: Determine sync plan
      debug:
        msg: "TODO: For each host, identify which certificates it needs to receive from other hosts"
      
    - name: Execute certificate synchronization
      debug:
        msg: "TODO: Copy certificate files between hosts"
