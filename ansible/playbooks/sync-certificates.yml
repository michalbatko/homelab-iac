- name: Synchronize certificates between automation hosts
  hosts: automation_hosts
  gather_facts: yes
  become: yes
  vars:
    letsencrypt_dir: /etc/letsencrypt/live
    ansible_ssh_timeout: 30
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30'
    
  tasks:
    - name: Find certificate directories
      find:
        paths: "{{ letsencrypt_dir }}"
        file_type: directory
      register: local_cert_dirs
      
    - name: Show found certificate directories 
      debug:
        msg: "{{ inventory_hostname }}: {{ local_cert_dirs.files | length }} certificates - {{ local_cert_dirs.files | map(attribute='path') | map('basename') | sort | join(', ') }}"
      
    - name: Extract certificate domains and expiry dates
      shell: |
        if [ -f "{{ item.path }}/cert.pem" ]; then
          domain=$(openssl x509 -in "{{ item.path }}/cert.pem" -subject -noout | sed 's/subject=CN = //')
          expiry_raw=$(openssl x509 -in "{{ item.path }}/cert.pem" -enddate -noout | cut -d= -f2)
          expiry=$(date -d "$expiry_raw" "+%Y%m%d-%H%M" 2>/dev/null || echo "$expiry_raw")
          echo "{{ item.path | basename }}:${domain}:${expiry}"
        else
          echo "{{ item.path | basename }}:MISSING:MISSING"
        fi
      loop: "{{ local_cert_dirs.files }}"
      register: cert_details
      changed_when: false
      no_log: true
      
    - name: Show certificate status summary
      debug:
        msg: "{{ inventory_hostname }}: {% for result in cert_details.results %}{%- set parts = result.stdout.split(':') -%}{%- set cert_name = parts[0] -%}{%- set domain = parts[1] -%}{%- set expiry = parts[2] -%}{%- if domain == 'MISSING' -%}[MISSING]{{ cert_name }}{%- else -%}[PRESENT]{{ cert_name }}({{ expiry }}){%- endif -%}{% if not loop.last %}; {% endif %}{% endfor %}"
      
    - name: Build certificate inventory across all hosts
      set_fact:
        global_cert_inventory: >-
          {%- set result = {} -%}
          {%- for host in groups['automation_hosts'] -%}
            {%- set _ = result.update({host: hostvars[host]['cert_details']['results'] | map(attribute='stdout') | list}) -%}
          {%- endfor -%}
          {{ result }}
      run_once: true
      delegate_to: localhost

    - name: Find latest certificate for each domain
      set_fact:
        latest_certificates: >-
          {%- set result = {} -%}
          {%- set all_domains = [] -%}
          {%- for host, cert_list in global_cert_inventory.items() -%}
            {%- for cert_data in cert_list -%}
              {%- set parts = cert_data.split(':') -%}
              {%- if parts[1] != 'MISSING' -%}
                {%- set _ = all_domains.append(parts[1]) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {%- for domain in all_domains | unique -%}
            {%- set domain_certs = [] -%}
            {%- for host, cert_list in global_cert_inventory.items() -%}
              {%- for cert_data in cert_list -%}
                {%- set parts = cert_data.split(':') -%}
                {%- if parts[1] == domain -%}
                  {%- set _ = domain_certs.append({'host': host, 'cert_name': parts[0], 'domain': parts[1], 'expiry': parts[2]}) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
            {%- set latest_cert = domain_certs | sort(attribute='expiry') | last -%}
            {%- set _ = result.update({domain: latest_cert}) -%}
          {%- endfor -%}
          {{ result }}
      run_once: true
      delegate_to: localhost

    - name: Determine sync plan - identify missing certificates
      set_fact:
        certificates_to_copy: >-
          {%- set result = [] -%}
          {%- for domain, latest_info in latest_certificates.items() -%}
            {%- set source_host = latest_info.host -%}
            {%- for target_host in groups['automation_hosts'] -%}
              {%- if target_host != source_host -%}
                {%- set matching_certs = [] -%}
                {%- for cert_entry in global_cert_inventory[target_host] -%}
                  {%- set parts = cert_entry.split(':') -%}
                  {%- if parts[1] == domain and parts[1] != 'MISSING' -%}
                    {%- set _ = matching_certs.append(parts[2]) -%}
                  {%- endif -%}
                {%- endfor -%}
                {%- if matching_certs | length == 0 -%}
                  {%- set copy_item = {
                    'domain': domain,
                    'source_host': source_host,
                    'target_host': target_host,
                    'cert_name': latest_info.cert_name,
                    'reason': 'missing'
                  } -%}
                  {%- set _ = result.append(copy_item) -%}
                {%- elif matching_certs[0] < latest_info.expiry -%}
                  {%- set copy_item = {
                    'domain': domain,
                    'source_host': source_host,
                    'target_host': target_host,
                    'cert_name': latest_info.cert_name,
                    'reason': 'outdated'
                  } -%}
                  {%- set _ = result.append(copy_item) -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ result }}
      run_once: true

    - name: Determine sync plan - identify outdated certificates
      set_fact:
        certificates_to_remove: >-
          {%- set result = [] -%}
          {%- for copy_item in certificates_to_copy -%}
            {%- if copy_item.reason == 'outdated' -%}
              {%- for cert_entry in global_cert_inventory[copy_item.target_host] -%}
                {%- set parts = cert_entry.split(':') -%}
                {%- if parts[1] == copy_item.domain and parts[1] != 'MISSING' -%}
                  {%- set remove_item = {
                    'host': copy_item.target_host,
                    'cert_name': parts[0],
                    'domain': copy_item.domain,
                    'old_expiry': parts[2],
                    'new_expiry': copy_item.cert_name + ' from ' + copy_item.source_host
                  } -%}
                  {%- set _ = result.append(remove_item) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endif -%}
          {%- endfor -%}
          {{ result }}
      run_once: true
      delegate_to: localhost

    - name: Show sync plan - certificates to copy
      debug:
        msg: "COPY: {{ item.domain }} from {{ item.source_host }}:{{ item.cert_name }} to {{ item.target_host }} ({{ item.reason }})"
      loop: "{{ certificates_to_copy }}"
      run_once: true
      when: certificates_to_copy | length > 0

    - name: Show sync plan - certificates to remove
      debug:
        msg: "REMOVE: {{ item.host }}:{{ item.cert_name }} ({{ item.domain }}) - replaced by {{ item.new_expiry }}"
      loop: "{{ certificates_to_remove }}"
      run_once: true
      when: certificates_to_remove | length > 0

    - name: Show sync plan summary
      debug:
        msg: "Sync plan: {{ certificates_to_copy | length }} certificates to copy, {{ certificates_to_remove | length }} certificates to remove"
      run_once: true
      
    - name: Execute certificate synchronization - copy archive files first
      synchronize:
        src: "/etc/letsencrypt/archive/{{ item.cert_name }}/"
        dest: "/etc/letsencrypt/archive/{{ item.cert_name }}/"
        rsync_opts:
          - "--perms"
          - "--owner"
          - "--group" 
          - "--times"
          - "--recursive"
          - "--delete"
      delegate_to: "{{ item.source_host }}"
      delegate_facts: false
      loop: "{{ certificates_to_copy }}"
      when: 
        - certificates_to_copy | length > 0
        - item.target_host == inventory_hostname
      
    - name: Execute certificate synchronization - copy live directory with symlinks
      synchronize:
        src: "{{ letsencrypt_dir }}/{{ item.cert_name }}/"
        dest: "{{ letsencrypt_dir }}/{{ item.cert_name }}/"
        rsync_opts:
          - "--perms"
          - "--owner" 
          - "--group"
          - "--times"
          - "--recursive"
          - "--delete"
          - "--links"
      delegate_to: "{{ item.source_host }}"
      delegate_facts: false
      loop: "{{ certificates_to_copy }}"
      when: 
        - certificates_to_copy | length > 0
        - item.target_host == inventory_hostname

    - name: Verify copied certificates exist and are valid
      stat:
        path: "{{ letsencrypt_dir }}/{{ item.cert_name }}/fullchain.pem"
      register: copied_cert_check
      loop: "{{ certificates_to_copy }}"
      when: 
        - certificates_to_copy | length > 0
        - item.target_host == inventory_hostname
      
    - name: Validate copied certificate files
      shell: |
        if [ -f "{{ letsencrypt_dir }}/{{ item.item.cert_name }}/fullchain.pem" ]; then
          openssl x509 -in "{{ letsencrypt_dir }}/{{ item.item.cert_name }}/fullchain.pem" -noout -subject > /dev/null
          echo "VALID"
        else
          echo "MISSING"
        fi
      loop: "{{ copied_cert_check.results }}"
      register: cert_validation
      when: 
        - certificates_to_copy | length > 0
        - copied_cert_check.results is defined
        - item is not skipped
      changed_when: false

    - name: Fail if any certificate validation failed
      fail:
        msg: "Certificate validation failed for {{ item.item.item.cert_name }}: {{ item.stdout }}"
      loop: "{{ cert_validation.results }}"
      when: 
        - certificates_to_copy | length > 0
        - cert_validation.results is defined
        - item is not skipped
        - item.stdout == "MISSING" or item.rc != 0

    - name: Remove outdated certificate directories from live
      file:
        path: "{{ letsencrypt_dir }}/{{ item.cert_name }}"
        state: absent
      loop: "{{ certificates_to_remove }}"
      when: 
        - certificates_to_remove | length > 0
        - item.host == inventory_hostname
        
    - name: Remove outdated certificate directories from archive
      file:
        path: "/etc/letsencrypt/archive/{{ item.cert_name }}"
        state: absent
      loop: "{{ certificates_to_remove }}"
      when: 
        - certificates_to_remove | length > 0
        - item.host == inventory_hostname
      
    - name: Show synchronization results
      debug:
        msg: "Certificate synchronization completed: {{ certificates_to_copy | length }} certificates copied, {{ certificates_to_remove | length }} old certificates removed"
      run_once: true
      when: (certificates_to_copy | length > 0) or (certificates_to_remove | length > 0)
