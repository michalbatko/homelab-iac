- name: Synchronize certificates between automation hosts
  hosts: automation_hosts
  gather_facts: yes
  become: yes
  vars:
    letsencrypt_dir: /etc/letsencrypt/live
    ansible_ssh_timeout: 30
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30'
    
  tasks:
    - name: Find certificate directories
      find:
        paths: "{{ letsencrypt_dir }}"
        file_type: directory
      register: local_cert_dirs
      
    - name: Show found certificate directories 
      debug:
        msg: "{{ inventory_hostname }}: {{ local_cert_dirs.files | length }} certificates - {{ local_cert_dirs.files | map(attribute='path') | map('basename') | sort | join(', ') }}"
      
    - name: Extract certificate domains and expiry dates
      shell: |
        if [ -f "{{ item.path }}/cert.pem" ]; then
          domain=$(openssl x509 -in "{{ item.path }}/cert.pem" -subject -noout | sed 's/subject=CN = //')
          expiry_raw=$(openssl x509 -in "{{ item.path }}/cert.pem" -enddate -noout | cut -d= -f2)
          expiry=$(date -d "$expiry_raw" "+%Y%m%d-%H%M" 2>/dev/null || echo "$expiry_raw")
          echo "{{ item.path | basename }}:${domain}:${expiry}"
        else
          echo "{{ item.path | basename }}:MISSING:MISSING"
        fi
      loop: "{{ local_cert_dirs.files }}"
      register: cert_details
      changed_when: false
      no_log: true
      
    - name: Show certificate status summary
      debug:
        msg: "{{ inventory_hostname }}: {% for result in cert_details.results %}{%- set parts = result.stdout.split(':') -%}{%- set cert_name = parts[0] -%}{%- set domain = parts[1] -%}{%- set expiry = parts[2] -%}{%- if domain == 'MISSING' -%}[MISSING]{{ cert_name }}{%- else -%}[PRESENT]{{ cert_name }}({{ expiry }}){%- endif -%}{% if not loop.last %}; {% endif %}{% endfor %}"
      
    - name: Build certificate inventory across all hosts
      set_fact:
        global_cert_inventory: "{{ global_cert_inventory | default({}) | combine({inventory_hostname: cert_details.results | map(attribute='stdout') | list}) }}"
      delegate_to: localhost
      delegate_facts: true

    - name: Find latest certificate for each domain
      set_fact:
        latest_certificates: >-
          {%- set result = {} -%}
          {%- set all_domains = [] -%}
          {%- for host, cert_list in global_cert_inventory.items() -%}
            {%- for cert_data in cert_list -%}
              {%- set parts = cert_data.split(':') -%}
              {%- if parts[1] != 'MISSING' -%}
                {%- set _ = all_domains.append(parts[1]) -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {%- for domain in all_domains | unique -%}
            {%- set domain_certs = [] -%}
            {%- for host, cert_list in global_cert_inventory.items() -%}
              {%- for cert_data in cert_list -%}
                {%- set parts = cert_data.split(':') -%}
                {%- if parts[1] == domain -%}
                  {%- set _ = domain_certs.append({'host': host, 'cert_name': parts[0], 'domain': parts[1], 'expiry': parts[2]}) -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
            {%- set latest_cert = domain_certs | sort(attribute='expiry') | last -%}
            {%- set _ = result.update({domain: latest_cert}) -%}
          {%- endfor -%}
          {{ result }}
      run_once: true
      delegate_to: localhost
      
    - name: Determine sync plan
      set_fact:
        sync_plan: >-
          {%- set plan = {'copy': [], 'remove': []} -%}
          {%- for domain, latest_cert in latest_certificates.items() -%}
            {%- for host, cert_list in global_cert_inventory.items() -%}
              {%- set host_certs = [] -%}
              {%- for cert_data in cert_list -%}
                {%- set parts = cert_data.split(':') -%}
                {%- if parts[1] == domain -%}
                  {%- set _ = host_certs.append({'cert_name': parts[0], 'domain': parts[1], 'expiry': parts[2]}) -%}
                {%- endif -%}
              {%- endfor -%}
              {%- if host != latest_cert.host -%}
                {%- if host_certs | length == 0 or (host_certs | selectattr('domain', 'ne', 'MISSING') | list | length == 0) -%}
                  {%- set _ = plan.copy.append({'target_host': host, 'source_host': latest_cert.host, 'source_cert_name': latest_cert.cert_name, 'domain': domain, 'expiry': latest_cert.expiry}) -%}
                {%- else -%}
                  {%- set current_certs = host_certs | selectattr('domain', 'ne', 'MISSING') | list -%}
                  {%- for cert in current_certs -%}
                    {%- if cert.expiry < latest_cert.expiry -%}
                      {%- set _ = plan.copy.append({'target_host': host, 'source_host': latest_cert.host, 'source_cert_name': latest_cert.cert_name, 'domain': domain, 'expiry': latest_cert.expiry}) -%}
                      {%- set _ = plan.remove.append({'host': host, 'cert_name': cert.cert_name, 'domain': domain, 'reason': 'outdated'}) -%}
                    {%- endif -%}
                  {%- endfor -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ plan }}
      run_once: true
      delegate_to: localhost
      
    - name: Execute certificate synchronization
      debug:
        msg: "TODO: Copy certificate files between hosts"
