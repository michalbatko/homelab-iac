- name: Synchronize certificates between automation hosts
  hosts: automation_hosts
  gather_facts: yes
  become: yes
  vars:
    letsencrypt_dir: /etc/letsencrypt/live
    ansible_ssh_timeout: 30
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30'
    
  tasks:
    - name: Find all certificate directories on each host
      find:
        paths: "{{ letsencrypt_dir }}"
        file_type: directory
      register: local_cert_dirs
      
    - name: Display found certificate directories
      debug:
        msg: "Found {{ local_cert_dirs.files | length }} certificate directories on {{ inventory_hostname }}: {{ local_cert_dirs.files | map(attribute='path') | map('basename') | list }}"
      
    - name: Get certificate expiry dates
      shell: |
        if [ -f "{{ item.path }}/fullchain.pem" ]; then
          openssl x509 -in "{{ item.path }}/fullchain.pem" -noout -enddate | sed 's/notAfter=//'
        else
          echo "MISSING"
        fi
      register: local_cert_expiry
      loop: "{{ local_cert_dirs.files }}"
      loop_control:
        label: "{{ item.path | basename }}"
      when: local_cert_dirs.files is defined
      
    - name: Create certificate inventory with expiry dates
      set_fact:
        local_certificates: >-
          {{
            local_certificates | default([]) +
            [{
              'domain': item.item.path | basename,
              'path': item.item.path,
              'expiry_date': item.stdout if item.stdout != "MISSING" else "",
              'expiry_epoch': (item.stdout | to_datetime('%b %d %H:%M:%S %Y %Z')).strftime('%s') | int if item.stdout != "MISSING" else 0,
              'exists': item.stdout != "MISSING",
              'host': inventory_hostname
            }]
          }}
      loop: "{{ local_cert_expiry.results }}"
      loop_control:
        label: "{{ item.item.path | basename }}"
      when: 
        - local_cert_expiry.results is defined
        - item.stdout is defined
        
    - name: Display local certificate inventory
      debug:
        msg: "Local certificates on {{ inventory_hostname }}: {{ local_certificates | default([]) | map(attribute='domain') | list }}"
        
    - name: Gather certificate info from all automation hosts
      set_fact:
        all_certificates: "{{ groups['automation_hosts'] | map('extract', hostvars, 'local_certificates') | list | flatten | default([]) }}"
      run_once: true
      
    - name: Display all certificates found across hosts
      debug:
        msg: "All certificates across hosts: {{ all_certificates | groupby('domain') | map('first') | list }}"
      run_once: true
      
    - name: Determine newest certificate for each domain
      set_fact:
        newest_certificates: >-
          {{
            newest_certificates | default({}) |
            combine({
              item.domain: all_certificates |
              selectattr('domain', 'equalto', item.domain) |
              selectattr('exists', 'equalto', true) |
              sort(attribute='expiry_epoch', reverse=true) |
              first
            })
          }}
      loop: "{{ all_certificates }}"
      loop_control:
        label: "{{ item.domain }}"
      when: 
        - item.exists
        - item.domain not in (newest_certificates | default({}))
      run_once: true
      
    - name: Display newest certificates by domain
      debug:
        msg: >-
          Domain: {{ item.key }}
          Host: {{ item.value.host }}
          expiry_date: {{ item.value.expiry_date }}
          expiry_epoch: {{ item.value.expiry_epoch }}
      loop: "{{ newest_certificates | default({}) | dict2items }}"
      loop_control:
        label: "{{ item.key }}"
      run_once: true
      
    - name: Identify certificates to sync to this host
      set_fact:
        certificates_to_sync: >-
          {{
            newest_certificates.values() |
            selectattr('host', 'ne', inventory_hostname) |
            rejectattr('domain', 'in', (local_certificates | default([]) | selectattr('exists') | map(attribute='domain') | list)) |
            list
          }}
      
    - name: Display certificates identified for sync
      debug:
        msg: "Certificates to sync to {{ inventory_hostname }}: {{ certificates_to_sync | map(attribute='domain') | list }} (from hosts: {{ certificates_to_sync | map(attribute='host') | list }})"
      
    - name: Create certificate directories for incoming certificates
      file:
        path: "{{ letsencrypt_dir }}/{{ item.domain }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop: "{{ certificates_to_sync }}"
      loop_control:
        label: "{{ item.domain }}"
      
    - name: Synchronize certificate files using direct rsync
      shell: |
        rsync -avz --timeout=120 \
          -e "ssh -i /opt/actions-runner/.ssh/ansible_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=30" \
          --delete \
          root@{{ item.host }}:{{ item.path }}/ {{ letsencrypt_dir }}/{{ item.domain }}/
      loop: "{{ certificates_to_sync }}"
      loop_control:
        label: "{{ item.domain }} from {{ item.host }}"
      when: certificates_to_sync | length > 0
      register: sync_results
      failed_when: false

    - name: Display sync results
      debug:
        msg: "Synced {{ item.item.domain }} from {{ item.item.host }}: {{ 'SUCCESS' if item.rc == 0 else 'FAILED' }}"
      loop: "{{ sync_results.results | default([]) }}"
      loop_control:
        label: "{{ item.item.domain }}"
      when: sync_results is defined

    - name: Display sync summary
      debug:
        msg: "Certificate sync completed: {{ certificates_to_sync | length }} domains synchronized to {{ inventory_hostname }}"
      when: certificates_to_sync is defined
