- name: Deploy certificates to nginx hosts
  hosts: proxy_hosts
  gather_facts: false
  become: yes

  tasks:
    - name: Show execution context
      shell: |
        echo "Hostname: $(hostname)"
        echo "User: $(whoami)"
        echo "Working directory: $(pwd)"
      register: context_info

    - name: Display execution context
      debug:
        var: context_info.stdout_lines

    - name: Create SSL directories
      file:
        path: "/etc/nginx/ssl/{{ item.domain }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      loop: "{{ nginx_certificates }}"

    - name: Copy certificate files
      synchronize:
        src: "/etc/letsencrypt/live/{{ item.domain }}/"
        dest: "/etc/nginx/ssl/{{ item.domain }}/"
        rsync_opts:
          - "--perms"
          - "--times"
          - "--recursive"
          - "--copy-links"
      delegate_to: "{{ groups['automation_hosts'][0] }}"
      delegate_facts: false
      loop: "{{ nginx_certificates }}"

    - name: Set file permissions
      file:
        path: "/etc/nginx/ssl/{{ domain_cert_pair[0].domain }}/{{ cert_file }}"
        owner: root
        group: root
        mode: "{{ '0600' if cert_file == 'privkey.pem' else '0644' }}"
      loop: "{{ nginx_certificates | product(['fullchain.pem', 'privkey.pem', 'cert.pem', 'chain.pem']) | list }}"
      vars:
        cert_file: "{{ domain_cert_pair[1] }}"
      loop_control:
        loop_var: domain_cert_pair

    - name: Reload nginx service
      systemd:
        name: nginx
        state: reloaded
        enabled: yes
