- name: Deploy certificate to Proxmox via API
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Display received proxmox certificates data
      debug:
        var: proxmox_certificates

    - name: Read Proxmox API token
      slurp:
        src: "{{ proxmox_api_token_file | default('/etc/letsencrypt/proxmox-api-token.ini') }}"
      register: api_token_content
      no_log: true

    - name: Set API token variable
      set_fact:
        proxmox_api_token: "{{ api_token_content.content | b64decode | trim }}"
      no_log: true

    - name: Read certificate files for each domain
      slurp:
        src: "/etc/letsencrypt/live/{{ item[0].domain }}/{{ cert_file }}"
      register: cert_files
      loop: "{{ proxmox_certificates | product(['cert.pem', 'privkey.pem', 'fullchain.pem']) | list }}"
      vars:
        cert_file: "{{ item[1] }}"
      loop_control:
        label: "{{ item[0].domain }}/{{ item[1] }}"

    - name: Deploy certificates to Proxmox
      uri:
        url: "{{ item.api_endpoint }}/api2/json/nodes/{{ item.api_endpoint | regex_replace('https://([^:]+):.*', '\\1') }}/certificates/custom"
        method: POST
        body_format: form-urlencoded
        body:
          certificates: "{{ cert_files.results | selectattr('item.0.domain', 'equalto', item.domain) | selectattr('item.1', 'equalto', 'fullchain.pem') | map(attribute='content') | first | b64decode }}"
          key: "{{ cert_files.results | selectattr('item.0.domain', 'equalto', item.domain) | selectattr('item.1', 'equalto', 'privkey.pem') | map(attribute='content') | first | b64decode }}"
          restart: 1
        headers:
          Content-Type: "application/x-www-form-urlencoded"
          Authorization: "PVEAPIToken={{ proxmox_api_token }}"
        validate_certs: false
        status_code: [200, 201, 202, 204]
      loop: "{{ proxmox_certificates }}"
      when: proxmox_certificates is defined and proxmox_certificates | length > 0
