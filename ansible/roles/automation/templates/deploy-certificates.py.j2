#!/usr/bin/env python3

import json
import logging
import os
import subprocess
import sys
import yaml
from pathlib import Path

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/letsencrypt/certificate-deployer.log'),
        logging.StreamHandler(sys.stdout)
    ]
)
sys.stdout.reconfigure(line_buffering=True)
logger = logging.getLogger(__name__)

class CertificateDeployer:
    def __init__(self, registry_path='/etc/letsencrypt/certificate-registry.yml'):
        self.registry_path = registry_path
        self.registry = self._load_registry()
        self.letsencrypt_dir = Path('/etc/letsencrypt/live')
        self.playbook_dir = Path('/etc/letsencrypt/deployment')
        self.inventory_path = '/etc/ansible/hosts.yml'
        self.ansible_ssh_key_path = '/opt/actions-runner/.ssh/ansible_key'
        
    def _load_registry(self):
        try:
            with open(self.registry_path, 'r') as f:
                registry = yaml.safe_load(f)
                logger.info(f"Loaded certificate registry containing {len(registry.get('certificates', {}))} definitions")
                return registry
        except FileNotFoundError:
            logger.error(f"Cannot open certificate registry '{self.registry_path}': No such file or directory")
            sys.exit(1)
        except yaml.YAMLError as e:
            logger.error(f"Cannot parse certificate registry: {e}")
            sys.exit(1)

    def deploy_nginx_certificates(self):
        deploy_playbook = self.playbook_dir / 'deploy-nginx-certificate.yml'
        
        if not deploy_playbook.exists():
            logger.error(f"Cannot open deployment playbook '{deploy_playbook}': No such file or directory")
            return False
        
        nginx_certificates = []
        for domain_name, cert_config in self.registry.get('certificates', {}).items():
            deployment_targets = cert_config.get('deployment_targets', [])
            for target in deployment_targets:
                if target.get('type') == 'nginx':
                    nginx_certificates.append({
                        'domain': domain_name,
                        'hosts': target.get('hosts', []),
                        'service': target.get('service', 'nginx'),
                        'config_path': target.get('config_path', '/etc/nginx/sites-available/default')
                    })
        
        if not nginx_certificates:
            logger.info("No nginx certificate deployments required")
            return True
        
        logger.info(f"Found {len(nginx_certificates)} domains requiring nginx deployment")
        for cert in nginx_certificates:
            logger.info(f"  - {cert['domain']} -> {len(cert['hosts'])} hosts")
        
        nginx_vars_file = '/tmp/nginx_certificates.json'
        with open(nginx_vars_file, 'w') as f:
            json.dump({'nginx_certificates': nginx_certificates}, f)
        
        cmd = [
            '/usr/bin/sudo', '-u', 'actions-runner',
            'ansible-playbook',
            str(deploy_playbook),
            '-i', self.inventory_path,
            '--private-key', self.ansible_ssh_key_path,
            '-e', f'@{nginx_vars_file}'
        ]
        
        logger.info("Deploying certificates to nginx servers")
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, cwd='/etc/letsencrypt', timeout=300)
            
            if result.stdout:
                logger.info(f"Deployment playbook output:\n{result.stdout}")
            
            if result.returncode == 0:
                logger.info("Certificate deployment completed successfully")
                return True
            else:
                logger.error(f"Certificate deployment failed with return code {result.returncode}")
                if result.stderr:
                    logger.error(f"Error output: {result.stderr.strip()}")
                return False
                
        except subprocess.TimeoutExpired:
            logger.error("Certificate deployment timed out after 300 seconds")
            return False
        
        except Exception as e:
            logger.error(f"Certificate deployment failed: {e}")
            return False
        
        finally:
            try:
                os.unlink(nginx_vars_file)
            except FileNotFoundError:
                pass
    
    def deploy_proxmox_certificates(self):
        deploy_playbook = self.playbook_dir / 'deploy-proxmox-certificate.yml'
        
        if not deploy_playbook.exists():
            logger.error(f"Cannot open deployment playbook '{deploy_playbook}': No such file or directory")
            return False
        
        proxmox_certificates = []
        for domain_name, cert_config in self.registry.get('certificates', {}).items():
            deployment_targets = cert_config.get('deployment_targets', [])
            for target in deployment_targets:
                if target.get('type') == 'proxmox_api':
                    proxmox_certificates.append({
                        'domain': domain_name,
                        'node': target.get('node'),
                        'api_endpoint': target.get('api_endpoint'),
                        'api_token_file': target.get('api_token_file', '/etc/letsencrypt/proxmox-api-token.ini')
                    })
        
        if not proxmox_certificates:
            logger.info("No proxmox certificate deployments required")
            return True
        
        logger.info(f"Found {len(proxmox_certificates)} domains requiring proxmox deployment")
        for cert in proxmox_certificates:
            logger.info(f"  - {cert['domain']} -> {cert['api_endpoint']}")
        
        proxmox_vars_file = '/tmp/proxmox_certificates.json'
        with open(proxmox_vars_file, 'w') as f:
            json.dump({'proxmox_certificates': proxmox_certificates}, f)
        
        cmd = [
            '/usr/bin/sudo', '-u', 'actions-runner',
            'ansible-playbook',
            str(deploy_playbook),
            '-i', self.inventory_path,
            '--private-key', self.ansible_ssh_key_path,
            '-e', f'@{proxmox_vars_file}'
        ]
        
        logger.info("Deploying certificates to proxmox servers")
        
        try:
            result = subprocess.run(cmd, capture_output=True, text=True, cwd='/etc/letsencrypt', timeout=300)
            
            if result.stdout:
                logger.info(f"Deployment playbook output:\n{result.stdout}")
            
            if result.returncode == 0:
                logger.info("Proxmox certificate deployment completed successfully")
                return True
            else:
                logger.error(f"Proxmox certificate deployment failed with return code {result.returncode}")
                if result.stderr:
                    logger.error(f"Error output: {result.stderr.strip()}")
                return False
                
        except subprocess.TimeoutExpired:
            logger.error("Proxmox certificate deployment timed out after 300 seconds")
            return False
        
        except Exception as e:
            logger.error(f"Proxmox certificate deployment failed: {e}")
            return False
        
        finally:
            try:
                os.unlink(proxmox_vars_file)
            except FileNotFoundError:
                pass

    def deploy_all_certificates(self):
        certificates = self.registry.get('certificates', {})
        
        if not certificates:
            logger.info("Certificate registry contains no certificate definitions")
            return True
        
        logger.info(f"Starting certificate deployment for {len(certificates)} domains")
        
        deployment_success = True
        
        if not self.deploy_nginx_certificates():
            logger.error("Failed to deploy certificates to nginx servers")
            deployment_success = False
        
        if not self.deploy_proxmox_certificates():
            logger.error("Failed to deploy certificates to proxmox servers")
            deployment_success = False
        
        return deployment_success

def main():
    if os.geteuid() != 0:
        logger.error("Script must be executed with root privileges")
        sys.exit(1)
    
    try:
        deployer = CertificateDeployer()
        success = deployer.deploy_all_certificates()
        sys.exit(0 if success else 1)
    
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        sys.exit(1)

if __name__ == '__main__':
    main()